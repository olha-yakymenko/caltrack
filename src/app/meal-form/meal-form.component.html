<form [formGroup]="mealForm">

  <!-- ================== STEP 1: Podstawowe dane ================== -->
  @if (step() === 1) {
    <h3>Krok 1: Podstawowe informacje o posiłku</h3>

    <label>
      Nazwa posiłku:
      <input formControlName="name" placeholder="Wpisz nazwę posiłku" />
    </label>
    @if (mealForm.controls.name.touched && mealForm.controls.name.errors) {
      @if (mealForm.controls.name.errors['required']) {
        <small class="error">Pole nazwa jest wymagane</small>
      }
      @if (mealForm.controls.name.errors['minlength']) {
        <small class="error">Minimum 3 znaki</small>
      }
      @if (mealForm.controls.name.errors['maxlength']) {
        <small class="error">Maksymalnie 50 znaków</small>
      }
    }

    <label>
      Data i godzina:
      <input type="datetime-local" formControlName="date" />
    </label>
    @if (mealForm.controls.date.touched && mealForm.controls.date.errors) {
      @if (mealForm.controls.date.errors['required']) {
        <small class="error">Pole data jest wymagane</small>
      }
    }

    <button 
      type="button" 
      (click)="next()"
      (keyup.enter)="next()"
      (keyup.space)="next()"
    >
      Dalej
    </button>
  }

  <!-- ================== STEP 2: Składniki ================== -->
  @if (step() === 2) {
    <h3>Krok 2: Składniki</h3>

    <div formArrayName="items">
      @for (item of mealForm.controls.items.controls; track $index) {
        @let itemIndex = $index;
        @let itemGroup = item;
        <div [formGroupName]="$index" class="ingredient-row">

        <label>
          Produkt:
          <input
          type="text"
          formControlName="productName"
          (input)="onSearch($event.target.value, $index)"
          placeholder="Wpisz nazwę produktu"
        />
        </label>

          @if (filteredProducts[itemIndex]?.length) {
            <ul class="autocomplete">
                @for (product of filteredProducts[itemIndex]; track product.id) {
                  <li>
                    <button
                      type="button"
                      class="autocomplete-item"
                      (click)="selectProduct(product, itemIndex)"
                      (keyup.enter)="selectProduct(product, itemIndex)"
                      (keyup.space)="selectProduct(product, itemIndex)"
                      tabindex="0"
                    >
                      {{ product.name }}
                    </button>
                  </li>
                }
                <li>
                  <button
                    type="button"
                    class="autocomplete-item add-new"
                    (click)="openAddProductModal(itemIndex)"
                    (keyup.enter)="openAddProductModal(itemIndex)"
                    (keyup.space)="openAddProductModal(itemIndex)"
                    tabindex="0"
                  >
                    + Dodaj "{{ itemGroup.controls.productName.value }}"
                  </button>
                </li>
              </ul>
          }

          @if (itemGroup.controls.productName.value && 
                itemGroup.controls.productName.value.length >= 2 &&
                !itemGroup.controls.productId.value &&  
                !hasExactMatchInProducts(itemGroup.controls.productName.value)) { 
              <div class="add-product-prompt">
                <button 
                  type="button" 
                  class="btn-add-custom"
                  (click)="openAddProductModal(itemIndex)"
                  (keyup.enter)="openAddProductModal(itemIndex)"
                  (keyup.space)="openAddProductModal(itemIndex)"
                  tabindex="0"
                >
                  Dodaj "{{ itemGroup.controls.productName.value }}" jako nowy produkt
                </button>
              </div>
            }
          
          @if (item.controls.productId.touched && item.controls.productId.errors) {
            @if (item.controls.productId.errors['required']) {
              <small class="error">Wybierz produkt lub dodaj nowy</small>
            }
          }

          <label>
            Ilość w gramach:
            <input type="number" formControlName="grams" placeholder="Ilość w gramach" />
          </label>
          @if (item.controls.grams.touched && item.controls.grams.errors) {
            @if (item.controls.grams.errors['required']) {
              <small class="error">Podaj wagę</small>
            }
            @if (item.controls.grams.errors['min']) {
              <small class="error">Minimalnie 1 gram</small>
            }
            @if (item.controls.grams.errors['max']) {
              <small class="error">Maksymalnie 2000 gramów</small>
            }
          }

          <button 
            type="button" 
            (click)="removeItem($index)"
            (keyup.enter)="removeItem($index)"
            (keyup.space)="removeItem($index)"
          >
            Usuń składnik
          </button>
        </div>
      }
    </div>

    @if (mealForm.controls.items.errors?.['totalGramsInvalid']) {
      <p class="error">Suma gramów musi być większa niż 0</p>
    }

    <button 
      type="button" 
      (click)="addItem()"
      (keyup.enter)="addItem()"
      (keyup.space)="addItem()"
    >
      + Dodaj składnik
    </button>
    
    <button 
      type="button" 
      (click)="back()"
      (keyup.enter)="back()"
      (keyup.space)="back()"
    >
      Wstecz
    </button>
    
    <button 
      type="button" 
      (click)="next()"
      (keyup.enter)="next()"
      (keyup.space)="next()"
    >
      Dalej
    </button>
  }

  <!-- ================== STEP 3: Podsumowanie ================== -->
  @if (step() === 3) {
    <h3>Krok 3: Podsumowanie</h3>

    <p><strong>Nazwa posiłku:</strong> {{ mealForm.controls.name.value }}</p>
    <p><strong>Data i godzina:</strong> {{ mealForm.controls.date.value }}</p>

    <h4>Składniki:</h4>
    <ul>
      @for (item of mealForm.controls.items.controls; track $index; let i = $index) {
        @let productId = item.controls.productId.value;
        @let productName = item.controls.productName.value || getProductName(productId);
        <li>
          <strong>{{ productName }}</strong> - {{ item.controls.grams.value }} g
          @if (item.controls.isCustomProduct.value) {
            <span class="custom-badge">(nowy produkt)</span>
          }
        </li>
      }
    </ul>

    <button 
      type="button" 
      (click)="back()"
      (keyup.enter)="back()"
      (keyup.space)="back()"
      [appDisabledIfInactive]="true"
    >
      Wstecz
    </button>
    
    <button 
      type="button" 
      (click)="saveMeal()" 
      [disabled]="mealForm.invalid"
      (keyup.enter)="saveMeal()"
      (keyup.space)="saveMeal()"
      [appDisabledIfInactive]="true"
    >
      Zapisz posiłek
    </button>
  }

</form>

@if (showAddProductModal) {
  <div
    class="modal-overlay"
    role="dialog"
    aria-modal="true"
    tabindex="0"
    (click)="closeAddProductModal()"
    (keyup.enter)="closeAddProductModal()"
    (keyup.space)="closeAddProductModal()"
    (keydown.escape)="closeAddProductModal()"
  >
    <div 
      class="modal-content" 
      (click)="$event.stopPropagation()"
      role="document"
      aria-labelledby="modal-title"
      tabindex="0"
      (keydown.escape)="closeAddProductModal()"
    >
      <h3 id="modal-title">Dodaj nowy produkt</h3>
      
      <div class="modal-body">
        <p>Dodajesz produkt: <strong>{{ modalData.productName }}</strong></p>
        
        <label>
          Kalorie na 100g:
          <input 
            type="number" 
            [(ngModel)]="modalData.caloriesPer100g"
            placeholder="np. 120"
            min="1"
            max="900"
            (keyup.enter)="saveCustomProduct()"
            #caloriesInput
           
          />
        </label>
        
        <div class="modal-actions">
          <button 
            type="button" 
            (click)="closeAddProductModal()"
            (keyup.enter)="closeAddProductModal()"
            (keyup.space)="closeAddProductModal()"
            [appDisabledIfInactive]="true"
          >
            Anuluj
          </button>
          
          <button 
            type="button" 
            (click)="saveCustomProduct()" 
            [disabled]="!modalData.caloriesPer100g"
            (keyup.enter)="saveCustomProduct()"
            (keyup.space)="saveCustomProduct()"
            [appDisabledIfInactive]="true"
          >
            Dodaj produkt
          </button>
        </div>
      </div>
    </div>
  </div>
}